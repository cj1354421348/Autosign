{% extends "layout.html" %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-8">
        <div class="card shadow rounded-4">
            <div class="card-header bg-body border-0 pt-4 px-4 d-flex justify-content-between align-items-center">
                <h2 class="h4 mb-0 fw-bold" id="page-title">ä»»åŠ¡è¯¦æƒ…</h2>
                <a href="/" class="btn btn-outline-secondary btn-sm">
                    <i class="bi bi-arrow-left"></i> è¿”å›åˆ—è¡¨
                </a>
            </div>
            <div class="card-body p-4">
                <form id="taskForm">
                    <div class="row g-3 mb-4">
                        <div class="col-md-6">
                            <label class="form-label fw-bold">ä»»åŠ¡åç§°</label>
                            <input type="text" class="form-control bg-body-tertiary" name="name" required
                                placeholder="ä¾‹å¦‚: æ¯æ—¥ç­¾åˆ°">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label fw-bold">è°ƒåº¦å‘¨æœŸ (Cron)</label>
                            <input type="text" class="form-control bg-body-tertiary" name="schedule" value="0 9 * * *"
                                required placeholder="m h d m w">
                        </div>
                        <div class="col-md-2">
                            <label class="form-label fw-bold">éšæœºå»¶è¿Ÿ (ç§’)</label>
                            <input type="number" class="form-control bg-body-tertiary" name="jitter" value="0" min="0"
                                placeholder="0">
                        </div>
                    </div>

                    <div class="mb-4">
                        <label class="form-label fw-bold">è¿è¡Œæ¨¡å¼</label>
                        <select class="form-select form-select-lg" name="mode" id="mode" onchange="toggleMode()">
                            <option value="COOKIE">ğŸª Cookie æ¨¡å¼ (ç®€å•)</option>
                            <option value="PASSWORD">ğŸ”‘ è´¦å·å¯†ç æ¨¡å¼ (é«˜çº§)</option>
                        </select>
                    </div>

                    <!-- Cookie Mode Config -->
                    <div id="section-cookie" class="p-3 bg-body-tertiary rounded border mb-3 d-none">
                        <h4 class="h6 text-primary mb-3">Cookie é…ç½®</h4>
                        <div class="mb-3">
                            <label class="form-label">ç­¾åˆ° URL</label>
                            <input type="url" class="form-control" name="cookie_signin_url"
                                placeholder="https://example.com/api/sign">
                        </div>

                        <div class="row g-3">
                            <div class="col-md-4">
                                <label class="form-label">è¯·æ±‚æ–¹æ³•</label>
                                <select class="form-select" name="cookie_method">
                                    <option value="GET">GET</option>
                                    <option value="POST">POST</option>
                                </select>
                            </div>
                            <div class="col-md-8">
                                <label class="form-label">é™„åŠ  Headers (JSON)</label>
                                <textarea class="form-control font-monospace text-muted" name="cookie_headers" rows="3"
                                    placeholder='{"User-Agent": "..."}'></textarea>
                            </div>
                        </div>

                        <div class="mt-3">
                            <label class="form-label">Cookie å†…å®¹</label>
                            <textarea class="form-control font-monospace" name="cookie_value" rows="5"
                                placeholder="key=value; key2=value2..."></textarea>
                        </div>

                        <div class="mt-3">
                            <label class="form-label">ç»“æœç­›é€‰æ­£åˆ™ (å¯é€‰)</label>
                            <input type="text" class="form-control font-monospace" name="cookie_result_regex"
                                placeholder='ä¾‹å¦‚: "label":"(.*?)".*?"cdk":"(.*?)"'>
                            <div class="form-text">è‹¥åŒ¹é…æˆåŠŸï¼Œé€šçŸ¥å†…å®¹å°†åªæ˜¾ç¤ºæ•è·ç»„çš„å†…å®¹ã€‚</div>
                        </div>
                    </div>

                    <!-- Password Mode Config -->
                    <div id="section-password" class="p-3 bg-body-tertiary rounded border mb-3 d-none">
                        <h4 class="h6 text-primary mb-3">è´¦å·å¯†ç æµç¨‹é…ç½®</h4>

                        <div class="row g-3 mb-3">
                            <div class="col-md-6">
                                <label class="form-label badge bg-secondary text-wrap text-start w-100">1. ç™»å½•
                                    URL</label>
                                <input type="url" class="form-control mt-1" name="pwd_login_url">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">ç™»å½•æ•°æ® (JSON Body)</label>
                                <textarea class="form-control font-monospace text-muted" name="pwd_login_payload"
                                    rows="4" placeholder='{"username": "admin", "password": "..."}'></textarea>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label badge bg-secondary text-wrap text-start w-100">2. Token
                                æå–è§„åˆ™</label>
                            <div class="input-group mt-1">
                                <span class="input-group-text"><i class="bi bi-regex"></i></span>
                                <input type="text" class="form-control font-monospace" name="pwd_token_rule"
                                    placeholder='ä¾‹å¦‚: "token":"(.*?)"'>
                            </div>
                            <div class="form-text">æ”¯æŒæ­£åˆ™æå–ï¼Œæˆ–è€…å¡«å†™ JSON å­—æ®µå (å¦‚ access_token)</div>
                        </div>

                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label badge bg-secondary text-wrap text-start w-100">3. ç­¾åˆ°
                                    URL</label>
                                <input type="url" class="form-control mt-1" name="pwd_signin_url">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">ç­¾åˆ° Headers (JSON)</label>
                                <textarea class="form-control font-monospace text-muted" name="pwd_signin_headers"
                                    rows="4" placeholder='{"Authorization": "Bearer {token}"}'></textarea>
                            </div>
                        </div>

                        <div class="mt-3">
                            <label class="form-label">ç»“æœç­›é€‰æ­£åˆ™ (å¯é€‰)</label>
                            <input type="text" class="form-control font-monospace" name="pwd_result_regex"
                                placeholder='ä¾‹å¦‚: "label":"(.*?)".*?"cdk":"(.*?)"'>
                            <div class="form-text">è‹¥åŒ¹é…æˆåŠŸï¼Œé€šçŸ¥å†…å®¹å°†åªæ˜¾ç¤ºæ•è·ç»„çš„å†…å®¹ã€‚</div>
                        </div>
                    </div>

                    <div class="mt-4 text-end">
                        <button type="submit" class="btn btn-primary btn-lg px-5 shadow">
                            <i class="bi bi-save"></i> ä¿å­˜é…ç½®
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    const TASK_ID = "{{ task_id if task_id else '' }}";

    document.addEventListener('DOMContentLoaded', () => {
        loadTaskEditor(TASK_ID);

        document.getElementById('taskForm').onsubmit = async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const mode = formData.get('mode');

            // Parse Form Data similar to before...
            // Logic is identical to previous script.js since API structure hasn't changed
            // Just updating the implementation inside this script block for self-containment if needed, 
            // but actually we should rely on the functions in `static/script.js` if they were generic enough.
            // However, `loadTaskEditor` is in script.js but the submit logic was inline in HTML before.
            // Let's implement the submit logic here.

            const task = {
                name: formData.get('name'),
                schedule: formData.get('schedule'),
                mode: mode,
                config: {}
            };

            const jitter = parseInt(formData.get('jitter') || 0);

            if (mode === 'COOKIE') {
                try {
                    task.config = {
                        jitter: jitter,
                        signin_url: formData.get('cookie_signin_url'),
                        cookie: formData.get('cookie_value'),
                        method: formData.get('cookie_method'),
                        headers: JSON.parse(formData.get('cookie_headers') || '{}')
                    };
                } catch (err) {
                    alert("Cookie Headers JSON æ ¼å¼é”™è¯¯: " + err.message);
                    return;
                }
            } else {
                try {
                    task.config = {
                        jitter: jitter,
                        login_url: formData.get('pwd_login_url'),
                        login_payload: JSON.parse(formData.get('pwd_login_payload') || '{}'),
                        token_extract_rule: formData.get('pwd_token_rule'),
                        signin_url: formData.get('pwd_signin_url'),
                        signin_headers: JSON.parse(formData.get('pwd_signin_headers') || '{}')
                    };
                } catch (err) {
                    alert("JSON æ ¼å¼é”™è¯¯: " + err.message);
                    return;
                }
            }

            try {
                const method = TASK_ID ? 'PUT' : 'POST';
                const url = TASK_ID ? `/api/tasks/${TASK_ID}` : '/api/tasks';

                // Change button state
                const btn = e.target.querySelector('button[type=submit]');
                const originalHtml = btn.innerHTML;
                btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> ä¿å­˜ä¸­...';
                btn.disabled = true;

                await apiCall(method, url, task);

                btn.className = "btn btn-success btn-lg px-5 shadow";
                btn.innerHTML = '<i class="bi bi-check-lg"></i> ä¿å­˜æˆåŠŸ!';

                setTimeout(() => {
                    window.location.href = '/';
                }, 800);
            } catch (err) {
                alert('ä¿å­˜å¤±è´¥: ' + err.message);
                const btn = e.target.querySelector('button[type=submit]');
                btn.innerHTML = originalHtml;
                btn.disabled = false;
            }
        };
    });
</script>
{% endblock %}